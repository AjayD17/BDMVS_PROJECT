{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="{% static 'css/styles.css' %}">

</head>
<body>

    <!-- Smaller Search Container -->
    <div class="search-container" 
     style="
         padding: 20px; /* Increased padding for spacious look */
         margin-bottom: 5px; 
         margin-top: 5px;
         text-align: center; 
         max-width: 700px; /* Significantly increased width */
         width: 75%; /* Maintains responsiveness */
         margin-left: auto;
         margin-right: auto;
     ">
    
    <form id="searchForm" method="GET" action="{% url 'search' %}">
        <input type="text" id="search_word" name="search_word"
               value="{{ query }}" 
               placeholder="Enter search word"
               style="
                   padding: 8px;
                   width: 80%; 
                   border: 2px solid  #0dcaf0;
                   border-radius: 20px;
                   font-size: 2.2vh;
                   background-color: #ffffff;
                   color: #0452fd;"required>
        <button type="submit"
                style="padding: 8px 16px; color: #fff; border: none; border-radius: 20px; cursor: pointer;gap:20px;
                background-color:rgb(240, 59, 59)">
            Search
        </button>
    </form>
</div>

    <div class="container">
        <!-- PDF Results Section -->
        <div id="book-results" class="panel left-panel">
            <h2>üìö Related Books</h2>
            <div id="pdf-results-container">
                
                <p>Loading PDF results...</p>  <!-- Placeholder for async results -->
            </div>
        </div>

        <!-- Google Search Results Section -->
        <div id="google-results" class="panel left-panel">
            <h2>üåê Google Search</h2>
            <div id="google-results-container">
                
                <p>Loading Google results...</p>  <!-- Placeholder for async results -->
            </div>
        </div>

        <!-- YouTube Results Section -->
        <div id="video-results" class="panel right-panel">
            <h2>üé¨ Related Videos</h2>
            <div id="youtube-results-container">
                
                <p>Loading YouTube results...</p>  <!-- Placeholder for async results -->
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const searchWord = new URLSearchParams(window.location.search).get("search_word") || "{{ query }}";

        const pdfContainer = document.getElementById("book-results");
        const googleContainer = document.getElementById("google-results");

        const googlePromise = fetch(`/ajax/search_google/?search_word=${encodeURIComponent(searchWord)}`)
            .then(response => response.json())
            .then(data => displayResults('google-results-container', data.google_results, 'google-thumbnail', '/static/images/default_image.png', 'google-info', 'Visit'));

        const youtubePromise = fetch(`/ajax/search_youtube/?search_word=${encodeURIComponent(searchWord)}`)
            .then(response => response.json())
            .then(data => displayResults('youtube-results-container', data.youtube_results, 'video-thumbnail', '/static/images/default_thumbnail.jpg', 'video-info', 'Watch'));

        const pdfStream = new EventSource(`/ajax/search_pdf/?search_word=${encodeURIComponent(searchWord)}`);
        pdfStream.onmessage = function (event) {
            const data = JSON.parse(event.data);
            appendBookResult(data);
            pdfContainer.style.display = "block"; 
        };

        function appendBookResult(data) {
            const pdfResultsContainer = document.getElementById('pdf-results-container');

            if (pdfResultsContainer.querySelector('p')) {
                pdfResultsContainer.innerHTML = ''; // Clear placeholder
            }

            const bookDiv = document.createElement('div');
            bookDiv.className = "result";
            const coverPath = data.book_cover.startsWith('/static') 
                              ? data.book_cover 
                              : `/static/covers/${data.book_cover}`;

            bookDiv.innerHTML = `
                <img src="${coverPath}" 
                     alt="${data.book_name}" 
                     class="book-cover" 
                     loading="lazy">
                <div class="book-info">
                    <h4>${data.book_name}</h4>
                    <a href="${data.download_link}" target="_blank">Download</a>
                </div>
            `;
            pdfResultsContainer.appendChild(bookDiv);
        }

        function displayResults(containerId, results, imageClass, defaultImage, infoClass, linkText) {
            const container = document.getElementById(containerId);
            if (!results || results.length === 0) {
                container.innerHTML = "<p>No results found.</p>";
                return;
            }

            container.innerHTML = results.map(result => `
                <div class="result">
                    <img src="${result.book_cover ? '/static/covers/' + result.book_cover : result.thumbnail || defaultImage}" 
                         alt="${result.book_name || result.title}" 
                         class="${imageClass}" 
                         loading="lazy">
                    <div class="${infoClass}">
                        <h4>${result.book_name || result.title}</h4>
                        <a href="${result.download_link || result.videoUrl}" target="_blank">${linkText}</a>
                    </div>
                </div>
            `).join('');
        }
    });
    </script>
</body>
</html>